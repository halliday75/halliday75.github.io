<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smartling Translation Example</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      color: #333;
    }
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
      padding: 10px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav h2 {
      margin: 0;
      font-size: 1.2rem;
      color: #444;
    }
    nav select {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      cursor: pointer;
    }
    main {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
      text-align: center;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    p {
      font-size: 1rem;
      color: #555;
    }
  </style>
</head>
<body>
  <nav>
    <h2>Partner Portal</h2>
    <select id="language"></select>
  </nav>

  <main>
    <h1 id="h1">Partner Portal</h1>
    <p id="p">Welcome to the partner portal.</p>
  </main>

  <script>
    const languageDropdown = document.getElementById("language");

    // ✅ Languages (English is default HTML, no Smartling call)
    const languages = {
      en: { name: "English" },
      fr: { name: "Francais", domain: "fr-fr-d81a9dafbd22d2d83.getsmartling.com" },
      es: { name: "Espanol", domain: "es-la-d81a9dafb3de12021.getsmartling.com" }
    };

    // ✅ Populate dropdown
    Object.entries(languages).forEach(([code, { name }]) => {
      const option = document.createElement("option");
      option.value = code;
      option.textContent = name;
      languageDropdown.appendChild(option);
    });

    // ✅ Collect all translatable elements from the static HTML
    const translatableElements = {};
    document.querySelectorAll("h1, h2, h3, h4, h5, h6, p, span, button, a, li, strong, em")
      .forEach((el, index) => {
        if (!el.textContent.trim()) return; // skip empty elements
        const key = el.id || `${el.tagName.toLowerCase()}-${index}`;
        el.dataset.translationKey = key; // store key for later
        translatableElements[key] = el.textContent.trim();
      });

    // ✅ Store default content for resetting
    const defaultContent = { ...translatableElements };

    async function translate(langCode) {
      if (langCode === "en") {
        revertToEnglish();
        return;
      }

      const domain = languages[langCode].domain;
      try {
        const response = await fetch(`https://${domain}/sl-api?smartling_editmode=0`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sl_translate: "sl_all",
            inputRequest: translatableElements
          })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        const translated = data.inputRequest;

        // ✅ Update elements if translation exists
        Object.entries(translated).forEach(([key, text]) => {
          const el = document.querySelector(`[data-translation-key="${key}"]`);
          if (el && text) el.textContent = text;
        });

      } catch (error) {
        console.error(`Translation request failed for ${langCode}:`, error);
      }
    }

    function revertToEnglish() {
      Object.entries(defaultContent).forEach(([key, text]) => {
        const el = document.querySelector(`[data-translation-key="${key}"]`);
        if (el) el.textContent = text;
      });
    }

    // ✅ Handle dropdown + localStorage
    languageDropdown.addEventListener("change", async (e) => {
      const lang = e.target.value;
      localStorage.setItem("preferredLanguage", lang);
      await translate(lang);
    });

    // ✅ Auto-load on page start
    document.addEventListener("DOMContentLoaded", async () => {
      let savedLang = localStorage.getItem("preferredLanguage");
      if (!savedLang) {
        const userLang = (navigator.language || navigator.userLanguage).slice(0, 2);
        savedLang = languages[userLang] ? userLang : "en";
      }
      languageDropdown.value = savedLang;
      await translate(savedLang);
    });
  </script>
</body>
</html>
